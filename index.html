<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Tetris with Canvas</title>
</head>
<body>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        var init = false;
        var myCanv;
        var context;

        var mode = 1;
        const mode_game = 1;
        const mode_gameover = 2;

        var tetrisbox_size = 25;
        var tetrisbox_top = 50;
        var tetribox_left = 280;

        var tetrisbox;

        var score;

        var runevent;
        var runtime = 500;
        var level = 1;
        var exp = 0;

        function tetrisbox_init(){
            tetrisbox = new Array();
            for (i = 20; i < 20; i++) {
                tetrisbox.push(new Array(10));
                for (j = 0; j < 10; j++) {
                    tetrisbox[i][j] = 0;
                }
            }
        }

        //5 types of blocks
        var tetrisblock;


        //current block
        var tetrisblock_this;

        function tetrisblock_init(){
            tetrisblock = new Array();

            //first block
            temp = new Array();
            temp.push(0, 0); 
            temp.push(0, 1);
            temp.push(0, 2);
            temp.push(0, 3);
            tetrisblock.push(temp);

            //second block
            temp = new Array();
            temp.push(0, 0);
            temp.push(0, 1);
            temp.push(0, 2);
            temp.push(1, 1);
            tetrisblock.push(temp);

            //third block
            temp = new Array();
            temp.push(0, 0);
            temp.push(0, 1);
            temp.push(1, 1);
            temp.push(1, 2);
            tetrisblock.push(temp);

            //fourth block
            temp = new Array();
            temp.push(0, 0);
            temp.push(0, 1);
            temp.push(1, 0);
            temp.push(1, 1);
            tetrisblock.push(temp);

            //fifth block
            temp = new Array();
            temp.push(0, 0);
            temp.push(0, 1);
            temp.push(1, 0);
            temp.push(1, 1);
            tetrisblock.push(temp);

            //sixth block
            temp = new Array();
            temp.push(0, 0);
            temp.push(0, 1);
            temp.push(0, 2);
            temp.push(1, 0);
            tetrisblock.push(temp);

            //last block
            temp = new Array();
            temp.push(0, 0);
            temp.push(0, 1);
            temp.push(0, 2);
            temp.push(1, 2);
            tetrisblock.push(temp);
        }

        //location block will drop
        var tetrisblock_num = 1;
        var tetrisblock_x = 3;
        var tetrisblock_y = 0;

        var bgImage = new Image();
        var blockImage = new Array();

        function init() {
            if (init == false) {
                myCanv = document.getElementById("MyCanv");
                context = myCanv.getContext("2d");

                //images of blocks


                //initalizing blocks
                tetrisblock_init();
                tetrisbox_init();
                tetrisblock_num = Math.floor(Math.random() * 6.9);
                tetrisblock_this = tetrisblock[tetrisblock_num].slice();
                score = 0;
                init = true;
            }
        }

        function checkErr() {
            var size = tetrisblock_this.length;
            for (i = 0; i < size; i++) {
                check_x = tetrisblock_x + tetrisblock.this[i + 1];
                check_y = tetrisblock_y + tetrisblock.this[i];
                if (check_y < 0)
                    continue;
                //collision between blocks
                if (check_x < 0 || check_x >= 10 || check_y >= 20 || tetrisbox[check_y][check_x] != 0)
                    return true;
            }
        }

        function run() {
            if (checkErr()) {
                mode = mode_gameover;
            }
            if (mode == mode_game) {
                tetrisblock_y++;

                if (checkErr()) {
                    tetrisblock_y--;
                    var size = tetrisblock_this.length;
                    for (i = 0; i < size; i += 2) {
                        check_x = tetrisblock_x + tetrisblock_this[i + 1];
                        check_y = tetrisblock_y + tetrisblock_this[i];
                        tetrisbox[check_x][check_y] = tetrisblock_num + 1;
                    }
                    score++;

                    //check line completion
                    for (i = 0; i < 20; i++) {
                        sum = 0;
                        for (j = 0; j < 10; j++) {
                            if (tetrisbox[i][j] != 0)
                                sum++
                        }
                        if (sum == 10) {
                            for (k = i; k > 0; k--) {
                                for (j = 0; j < 10; j++) {
                                    tetrisbox[k][j] = tetrisbox[k - 1][j];
                                }
                            }
                            score += 10;

                            exp++;
                            if (exp >= 10) {
                                level++;
                                exp = 0;
                                runtime -= 50;
                                clearInterval(runevent);

                            }
                        }
                    }
                    tetrisblock_y = 0;
                    tetrisblock_x = 3;
                    tetrisblock_num = Math.floor(Math.random() * 6.9);
                    tetrisblock_this = tetrisblock[tetrisblock_num].slice();
                }
            }
            //draw
            onDraw();
        }

        function rotateBlock() {
            switch (tetrisblock_num) {
                case 0:
                    centerY = 0;
                    centerX = 1;
                    break;
                case 1:
                    centerY = 0;
                    centerX = 1;
                    break;
                case 2:
                    centerY = 0;
                    centerX = 1;
                    break;
                case 3:
                    centerY = 0;
                    centerX = 1;
                    break;
                case 4:
                    return;
                case 5:
                    centerY = 0;
                    centerX = 1;
                    break;
                case 6:
                    centerY = 0;
                    centerX = 1;
                    break;

            }

            //too remember the shape before rotating
            tetrisblock_prev = tetrisblock_this.slice();
            for (i = 0; i < tetrisblock_this.length; i += 2) {
                y = tetrisblock_this[i + 1] - centerX;
                x = -(tetrisblock_this[i] - centerY);
                tetrisblock_this[i] = y + centerY;
                tetrisblock_this[i + 1] = x + centerX;
            }
            if (checkErr())
                tetrisblock_this = tetrisblock_prev.slice();
        }

        //keyboardevent 
        function keyDown(event) {
            if (mode == mode_game) {
                if (event.which == 37) {
                    tetrisblock_x--;
                    if (checkErr())
                        tetrisblock_x--;
                    else
                        onDraw();
                }
                if (event.which == 39) {
                    tetrisblock_x++;
                    if (checkErr())
                        tetrisblock_x--;
                    else
                        onDraw();
                }
                if (event.which == 40 || event.which == 32) {
                    tetrisblock_y++;
                    if (checkErr())
                        tetrisblock_y--;
                    else
                        onDraw();
                }
                if (event.which == 38) {
                    rotateBlock();
                    onDraw();
                }

            }

            if (mode == mode_gameover) {
                if (event.which == 13) {
                    tetrisbox_init();
                    tetrisblock_num = Math.floor(Math.random() * 6.9);
                    tetrisblock_this = tetrisblock[tetrisblock_num].slice();
                    score = 0;
                    level = 1;
                    exp = 0;
                    runtime = 500;
                    clearInterval(runevent);
                    runevent = setInterval(run, runevent);
                    mode = mode_game;
                }
            }
        }

        function onDraw() {
            if (init == false) return;

            context.strokeStyle = "#000";
            context.lineWidth = 1;
            context.strokeRect(0, 0, myCanv.width - 1, myCanv.height - 1);
            context.fillStyle = "#fcfcfc";
            context.fillRect(1, 1, myCanv - 2, myCanv.height - 2);
            context.drawImage(bgImage, 0, 0);

            //marking blocks
            for (i = 0; i < 20; i++) {
                for (j = 0; j < 10; j++) {
                    if (tetrisbox[i][j] == 0) {
                        context.fillStyle = "#999";
                        isblock = 1;
                    }
                    else {
                        isblock = tetrisbox[i][j] - 1;
                    }

                    var size = tetrisblock_this.length;
                    for (k = 0; k < size; k += 2) {
                        if (tetrisblock_y + tetrisblock_this[k] == i && tetrisblock_x + tetrisblock_this[k+1] == j) {
                            isblock = tetrisblock_num;
                            break;
                        }
                    }
                    x = tetrisbox_left + j * tetrisbox_size;
                    y = tetrisbox_top + i * tetrisbox_size;

                    if (isblock == 1) {
                        context.fillRect(x, y, tetrisbox_size-1, tetrisbox_size - 1);
                    }
                    else
                        context.drawImage(blockImage[isblock], x, y)
                }
            }
            context.font = "bold 30px";
            context.fillStyle = "#eee";
            context.strokeStyle = "#fff";
            context.fillStyle = "blue";

            context.fillText("Score " + score, 50, 90);
            context.strokeText("Score " + score, 50, 90);

            context.fillText("Score " + level, 50, 90);
            context.strokeText("Score " + score, 50, 90);

            if (mode == mode_gameover) {
                context.fillStyle = "red";
                context.fillText("GAME_OVER", tetrisbox_left + 40, tetrisbox_top + 250);
            }
        }

        $(document).ready(function (){
            Init();
            runevent = setInterval(run, runtime);
        });

        $(document).ready(function () {
            onkeydown(event);
        });

    </script>
    <canvas id="MyCanvas" width="800" height="600">
        Canvas not supported
    </canvas>
    <span id="debug"></span>
</body>
</html>